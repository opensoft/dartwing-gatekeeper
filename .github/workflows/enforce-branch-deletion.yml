name: Enforce Branch Deletion Permissions by Owner

on:
  delete:

jobs:
  check-branch-ownership:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Verify branch deletion permissions
        run: |
          DELETED_BRANCH="${{ github.event.ref }}"
          DELETER="${{ github.actor }}"
          
          # List of protected branches (admin only can delete)
          PROTECTED_BRANCHES=("main" "develop" "staging" "production")
          
          # Admin users who can delete any branch
          ADMINS=("brettheap" "claude" "perplexity-bot")
          
          # Check if branch is protected
          for protected in "${PROTECTED_BRANCHES[@]}"; do
            if [[ "$DELETED_BRANCH" == "$protected" ]]; then
              # Check if deleter is admin
              is_admin=false
              for admin in "${ADMINS[@]}"; do
                if [[ "$DELETER" == "$admin" ]]; then
                  is_admin=true
                  break
                fi
              done
              
              if [[ "$is_admin" == false ]]; then
                echo "❌ ERROR: Cannot delete protected branch '$DELETED_BRANCH' unless you are an admin"
                exit 1
              fi
            fi
          done
          
          # For non-protected branches, enforce owner-based deletion
          # Extract branch owner from naming convention: owner/branch-name
          if [[ "$DELETED_BRANCH" =~ ^([^/]+)/(.+)$ ]]; then
            BRANCH_OWNER="${BASH_REMATCH[1]}"
            
            # Check if deleter matches branch owner (case-insensitive)
            if [[ "${BRANCH_OWNER,,}" != "${DELETER,,}" ]]; then
              echo "❌ ERROR: Cannot delete branch '$DELETED_BRANCH' created by '$BRANCH_OWNER'. Only the creator or admins can delete it."
              echo "Current deleter: $DELETER"
              exit 1
            fi
            echo "✅ Branch deletion allowed: $DELETER deleted their own branch $DELETED_BRANCH"
          else
            # Branch doesn't follow naming convention - allow deletion
            # (For backwards compatibility with branches not using owner prefix)
            echo "✅ Branch deletion allowed: $DELETER deleted branch $DELETED_BRANCH (no owner prefix)"
          fi
          
          exit 0
