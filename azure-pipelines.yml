name: $(Date:yyyyMMdd).$(Rev:r)

trigger:
#- main
- none

stages:
- stage: BUILD
  jobs:
  - job: BuildJob
    pool:
      vmImage: ubuntu-24.04

    variables:
    - name: BuildConfiguration
      value: release
    - name: BuildPlatform
      value: 'any cpu'
    
    steps:
    - task: UseDotNet@2
      displayName: 'Use .Net Core'
      inputs:
          version: $(NETCORE)

    - task: DotNetCoreCLI@2
      displayName: 'dotnet restore'
      inputs:
          command: restore
          projects: src/DartWing/DartWing.sln
          vstsFeed: '6848a223-49e7-4d7e-958d-59c7b27a82b8'

    - task: DotNetCoreCLI@2
      displayName: 'dotnet Publish'
      inputs:
          command: publish
          publishWebProjects: false
          projects: src/DartWing/DartWing.sln
          arguments: '--configuration $(BuildConfiguration) --output $(build.artifactstagingdirectory)'
          zipAfterPublish: false
          vstsFeed: '6848a223-49e7-4d7e-958d-59c7b27a82b8'

    - bash: |
        tree $(build.artifactstagingdirectory)

    - task: eliostruyf.build-task.custom-build-task.file-creator@4
      displayName: 'Create Dockerfile'
      inputs:
          fileoverwrite: true
          filepath: '$(build.artifactstagingdirectory)/Dockerfile'
          filecontent: |
            FROM $(FROM)

            ENV DOTNET_TieredPGO=1
            ENV DOTNET_TC_QuickJitForLoops=1
            ENV DOTNET_ReadyToRun=0

            WORKDIR /app
            COPY ./DartWing /app

            EXPOSE 80 443

            ENTRYPOINT ["dotnet", "DartWing.Web.dll"]

    - task: Docker@2
      displayName: 'buildAndPush image'
      inputs:
          containerRegistry: dotNetFarheap
          repository: 'DartWing-Service-$(Build.SourceBranchName)'
          Dockerfile: '$(build.artifactstagingdirectory)/Dockerfile'
          buildContext: '$(build.artifactstagingdirectory)/'
          tags: |
            $(Build.BuildId)
            latest

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: DartWing-Service'
      inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)/'
          ArtifactName: 'dartwing-service'   